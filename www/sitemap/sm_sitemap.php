<?php

/**
 * 船说 神马结构化站点地图 sm_sitemap 自动生成工具 2021年2月27日
 * 
 * 自动读取链接格式,ID转换规则等,访问时;显示神马标准的XML格式
 * 
 * 配合伪静态规则, 提交为xml后缀文件,一次提交,永久受益.  
 * 
 * 访问路径: http://你的域名/sitemap/sm_sitemap.xml
 * 
 */

$per_page = 99; // 一个索引文件,多少本 (注: 神马要求一个页面不能超过1000个链接)


/***** 以下代码请勿修改. *******/

header("Cache-Control: no-store, no-cache, must-revalidate");date_default_timezone_set('Asia/Chongqing');set_time_limit(300);define('__ROOT_DIR__',dirname(dirname(__DIR__)));require_once __ROOT_DIR__.'/shipsay/configs/config.ini.php';spl_autoload_register('ss_autoload');if(!empty($authcode))$dbarr['host']=$authcode;$articlecode_str=$sys_ver<2.4?'':'articlecode,';$dbarr=array_merge(['pre'=>$sys_ver<5?'jieqi_':'shipsay_','words'=>$sys_ver<2.4?'size':'words','sortarr'=>$sortarr,'is_multiple'=>$is_multiple],$dbarr);$db=new Db($dbarr);$xml='<?xml version="1.0"  encoding="UTF-8" ?>'."\r\n";if(empty($site_url)){$site_url=$_SERVER['SERVER_PORT']==443?'https://':'http://';$site_url.=$_SERVER['HTTP_HOST'];}if(isset($_GET['page'])){if(intval($_GET['page'])==0){$static_url[]=$site_url;foreach(Sort::ss_sorthead()as $v){$static_url[]=$site_url.$v['sorturl'];}$currentdate=date('Y-m-d').'T'.date('H:i:s');for($i=0;$i<count($static_url);$i++){$xml.='<url>'."\r\n";$xml.='  <loc>'.$static_url[$i].'</loc>'."\r\n";$xml.='  <lastmod>'.date('Y-m-d H:i:s').'</lastmod>'."\r\n";$xml.='  <changefreq>always</changefreq>'."\r\n";$i==0?$xml.='  <priority>1.00</priority>':$xml.='  <priority>0.95</priority>';$xml.="\r\n".'</url>'."\r\n";}}else{$xml.="<document>\r\n";$xml.="  <webName>![CDATA[".SITE_NAME."]]</webName>\r\n";$xml.="  <hostName>![CDATA[".$_SERVER['HTTP_HOST']."]]</hostName>\r\n";$xml.="  <datalist>\r\n";$start_offset=(intval($_GET['page'])-1)*$per_page;$sql='SELECT '.$dbarr['words'].','.$articlecode_str.'articleid,sortid,lastupdate,articlename,author,imgflag,intro,lastchapter,lastchapterid,fullflag FROM '.$dbarr['pre'].'article_article WHERE '.$dbarr['words'].' > 0 ORDER BY lastupdate DESC LIMIT '.$start_offset.','.$per_page;$res_article=$db->ss_query($sql);$k=0;while($row=mysqli_fetch_array($res_article)){$aid=$locid=$is_multiple?ss_newid($row['articleid']):$row['articleid'];if(strpos($fake_info_url,'{acode}')!==false){$locid=$row['articlecode'];}$_lastupdate=date('Y-m-d',$row['lastupdate']);$_url=$is_3in1?Url::index_url($locid):Url::info_url($locid);$_imgurl=Url::get_img_url($aid,$row['imgflag']);$_intro_des=Text::ss_txt2des(Text::ss_toutf8($row['intro']));$_sortname=$dbarr['sortarr'][$row['sortid']]['caption'];$_lastchapterid=$dbarr['is_multiple']?ss_newid($row['lastchapterid']):$row['lastchapterid'];$_lastchapterurl=Url::chapter_url($aid,$_lastchapterid);$_fullflag=$row['fullflag']==1?2:1;$_words=$row[$dbarr['words']];$xml.="   <item>\r\n";$xml.="     <url>![CDATA[".$site_url.$_url."]]</url>\r\n";$xml.="     <title>![CDATA[".xmltext($row['articlename'])."最新章节列表]]</title>\r\n";$xml.="     <summary>![CDATA[".xmltext($_intro_des)."]]</summary>\r\n";$xml.="     <name>![CDATA[".xmltext($row['articlename'])."]]</name>\r\n";$xml.="     <author>![CDATA[".xmltext($row['author'])."]]</author>\r\n";$xml.="     <category>![CDATA[".$_sortname."]]</category>\r\n";$xml.="     <latestChapterUrl>![CDATA[".$site_url.$_lastchapterurl."]]</latestChapterUrl>\r\n";$xml.="     <latestChapterTitle><![CDATA[".Text::ss_toutf8($row['lastchapter'])."]]></latestChapterTitle>\r\n";$xml.="     <cover><![CDATA[".$_imgurl."]]></cover>\r\n";$xml.="     <isEssential><![CDATA[1]]></isEssential>\r\n";$xml.="     <isHot><![CDATA[1]]></isHot>\r\n";$xml.="     <status><![CDATA[".$_fullflag."]]></status>\r\n";$xml.="     <tags><![CDATA[".$_sortname."]]></tags>\r\n";$xml.="     <updateTime><![CDATA[".$_lastupdate."]]></updateTime>\r\n";$xml.="     <wordCount><![CDATA[".$_words."]]></wordCount>\r\n";$xml.="   </item>\r\n";$k++;}$xml.="  </datalist>\r\n";$xml.="</document>";}}else{$totalsql='SELECT COUNT(articleid) as allbooks FROM '.$dbarr['pre'].'article_article WHERE '.$dbarr['words'].' > 0';$allrows=$db->ss_getone($totalsql)['allbooks'];$allpage=ceil($allrows/$per_page);$xml.='<sitemapindex>'."\r\n";for($i=1;$i<=$allpage;$i++){$xml.='<sitemap>'."\r\n";$xml.='  <loc>'.$site_url.'/sitemap/sm_sitemap_'.$i.'.xml</loc>';$xml.="\r\n".'</sitemap>'."\r\n";}$xml.='</sitemapindex>';}header('Content-type: text/xml');ob_clean();echo $xml;function ss_autoload($classname){if(!class_exists($classname))require __ROOT_DIR__.'/shipsay/class/'.$classname.'.php';}function xmltext($text){$entities=array('&'=>'&amp;','<'=>'&lt;','>'=>'&gt;','\''=>'&apos;','"'=>'&quot;');$text=strtr($text,$entities);$text=preg_replace('/[\\x00-\\x08\\x0b-\\x0c\\x0e-\\x1f]/','',$text);return $text;}